## RDB

### save & bgsave

| 类型   | IO类型 | 是否阻塞客户端命令                |
| ------ | ------ | --------------------------------- |
| save   | 同步   | 是                                |
| bgsave | 异步   | 否，调用fork是短暂阻塞（COW机制） |

### fork & copy on write

bgsave是fork()一个子进程进行快照，快照过程中主进程使用copyOnWrite方式继续工作；

fork创建的子进程，可以访问父进程的内存数据，但是修改不会影响父进程内存数据，而且创建进程时只是复制指针，只有在修改的时候才会创建一个新的数据，并把指针指向新的数据，即copy on write

### RDB优缺点

#### 优点

+ 宕机恢复速度快

#### 缺点

+ 丢失数据相对多一些（未备份的数据）
+ 不支持拉链，只有一个dump.rdb

## AOF

同时启用AOF和RDB会使用AOF进行宕机恢复，保证数据正确性

### AOF优缺点

#### 优点

+ 丢失数据少

#### 缺点

+ 体量越来越大
+ 恢复速度慢

### 写入磁盘时机

+ always:每次写入都执行flush
+ everysec:没秒执行一次flush
+ no:依靠linux调度执行flush,写入buffer没执行flush会丢失

### AOF重写

+ 4.0以前：删除抵消命令，合并重复命令
+ 4.0以后：RDB+AOF，将老的数据RDB到aof文件中

